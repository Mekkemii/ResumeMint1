# Внедрение Structured Outputs для оценки резюме

## Проблема
Система оценки резюме возвращала нестабильные результаты:
- Оценки "0/100" вместо реальных значений
- Разные форматы ответов (текст vs JSON)
- Несовпадение результатов между ручным тестированием и API

## Решение: Structured Outputs

### 1. Жёсткая JSON-схема (`backend/schemas/resumeEvaluation.js`)

**Структура ответа:**
```json
{
  "grade": {
    "level": "Junior|Middle|Senior|Lead",
    "rationale": "обоснование грейда"
  },
  "scores": {
    "text": 0-100,
    "structure": 0-100,
    "overall": 0-100
  },
  "strengths": ["сильные стороны"],
  "gaps": ["недостатки"],
  "add": ["рекомендации"],
  "ats": {
    "score": 0-100,
    "notes": "заметки по ATS"
  },
  "questions": ["уточняющие вопросы"]
}
```

**Валидация:**
- Все оценки - целые числа 0-100
- Обязательные поля проверяются на уровне схемы
- Максимальная длина строк ограничена

### 2. Строгий API-промпт (`backend/prompts/apiResumeReview.js`)

**Особенности:**
- Минималистичные инструкции
- Чёткие критерии оценки
- Поддержка HH-форматов резюме
- Инструкции по распознаванию маркеров опыта

### 3. Сервис Structured Outputs (`backend/services/openaiStructured.js`)

**Параметры запроса:**
```javascript
{
  model: 'gpt-4o-mini',
  temperature: 0.2,
  top_p: 1,
  seed: 42, // Фиксированный seed для воспроизводимости
  response_format: {
    type: "json_schema",
    json_schema: {
      name: "ResumeMintEvaluation",
      schema: resumeEvaluationSchema,
      strict: true
    }
  }
}
```

**Преимущества:**
- Гарантированный формат ответа
- Воспроизводимые результаты
- Автоматическая валидация
- Fallback-обработка ошибок

### 4. Обновлённый эндпоинт (`backend/server.js`)

**Изменения:**
- Использование нового сервиса `evaluateResumeStructured`
- Подробное логирование для диагностики
- Сохранение информации о модели и токенах

## Результат

✅ **Стабильные оценки:** Всегда числовые значения 0-100
✅ **Воспроизводимость:** Фиксированный seed обеспечивает одинаковые результаты
✅ **Валидация:** Автоматическая проверка структуры ответа
✅ **Диагностика:** Подробные логи с информацией о модели и токенах
✅ **Fallback:** Graceful обработка ошибок с понятными сообщениями

## Конфигурация

### Переменные окружения
```bash
# OpenAI API Configuration
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4o-mini  # Модель для оценки резюме
```

### Логирование
Система логирует:
- Модель и её fingerprint
- Количество токенов (prompt/completion)
- Результаты оценки
- Ошибки и их обработку

## Тестирование

```bash
# Запуск теста Structured Outputs
node test_structured_outputs.js

# Запуск сервера
npm start

# Тестирование через API
curl -X POST http://localhost:5000/api/resume/review \
  -H "Content-Type: application/json" \
  -d '{"resumeText": "Текст резюме..."}'
```

## Совместимость

- ✅ Обратная совместимость с существующим API
- ✅ Поддержка всех форматов резюме (стандартные, HH, фриланс)
- ✅ Интеграция с детектором опыта работы
- ✅ Кэширование результатов

## Мониторинг

Для мониторинга работы системы используйте логи:
```bash
# Просмотр логов в реальном времени
tail -f logs/app.log

# Поиск ошибок
grep "ERROR" logs/app.log

# Статистика использования токенов
grep "Токены:" logs/app.log
```
