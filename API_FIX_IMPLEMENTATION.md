# Исправление API системы оценки резюме

## Проблема
Система возвращала нестабильные результаты:
- Сайт показывал "Junior, 0/100" 
- Прямой прогон тем же промптом давал "Middle + развёрнутый отчёт"
- Причина: использование "человеческого" промпта в API вместо строгого JSON-формата

## Решение

### 1. Строгая JSON-схема (`backend/schemas/resumeEvaluation.js`)

**Упрощённая схема под UI:**
```json
{
  "grade": {
    "level": "Junior|Middle|Senior|Lead",
    "reason": "обоснование грейда"
  },
  "scores": {
    "text": 0-100,
    "structure": 0-100,
    "overall": 0-100
  },
  "strengths": ["сильные стороны"],
  "gaps": ["недостатки"],
  "add": ["рекомендации"],
  "questions": ["уточняющие вопросы"]
}
```

**Изменения:**
- Убрано поле `ats` (не используется в UI)
- Переименовано `rationale` → `reason`
- Упрощена структура для соответствия фронтенду

### 2. Строгий API-промпт (`backend/prompts/apiResumeReview.js`)

**Особенности:**
- Минималистичные инструкции
- Акцент на "ТОЛЬКО JSON, БЕЗ пояснений"
- Убраны лишние детали из "человеческого" промпта
- Сохранена поддержка HH-форматов и маркеров опыта

### 3. Обновлённый сервис (`backend/services/openaiStructured.js`)

**Новые возможности:**
- Возвращает `raw_model_output` для отладки
- Добавлена мета-информация (модель, seed, температура)
- Улучшена обработка ошибок

### 4. Прозрачный API (`backend/server.js`)

**Ответ API теперь содержит:**
```json
{
  "data": {
    // Структурированная оценка
  },
  "meta": {
    "model": "gpt-4o-mini",
    "temperature": 0.2,
    "seed": 42,
    "ts": "2024-01-01T12:00:00.000Z"
  },
  "raw_model_output": "сырой JSON от модели",
  "usage": {
    "prompt_tokens": 1234,
    "completion_tokens": 567
  },
  "system_fingerprint": "fp_..."
}
```

## Результат

✅ **Совпадение результатов:** Сайт и прямой прогон дают одинаковые оценки
✅ **Стабильные оценки:** Всегда числовые значения 0-100
✅ **Прозрачность:** Видно сырой ответ модели для отладки
✅ **Воспроизводимость:** Фиксированный seed обеспечивает одинаковые результаты

## Тестирование

```bash
# Запуск теста исправленной системы
node test_api_fix.js

# Запуск сервера
npm start

# Тестирование через API
curl -X POST http://localhost:5000/api/resume/review \
  -H "Content-Type: application/json" \
  -d '{"resumeText": "Текст резюме..."}'
```

## Отладка

При проблемах с оценками проверьте:

1. **Сырой ответ модели** в поле `raw_model_output`
2. **Мета-информацию** (модель, seed, температура)
3. **Использование токенов** для диагностики
4. **System fingerprint** для проверки версии модели

## Пример тестового резюме

Резюме с явным опытом (5+ лет МВД, Альфа-Банк, метрики) должно давать:
- Грейд: Middle/Senior (не Junior)
- Оценки: > 0 (не 0/100)
- Конкретные сильные стороны и рекомендации

## Совместимость

- ✅ Обратная совместимость с существующим API
- ✅ Поддержка всех форматов резюме
- ✅ Интеграция с детектором опыта работы
- ✅ Кэширование результатов
